#!/bin/bash
#
# Run a buildbot slave in the foreground. This script is intended to be run
# inside a Docker container.
#

# check for required environment variables
: ${BUILDBOT_MASTER:?"Need to set BUILDBOT_MASTER environment variable"}
: ${BUILDSLAVE_USER:?"Need to set BUILDSLAVE_USER environment variable"}
: ${BUILDSLAVE_PASS:?"Need to set BUILDSLAVE_PASS environment variable"}

# ensure that other environment variables are set
: ${BUILDSLAVE_ADMIN:="Your Name Here <admin@youraddress.invalid>"}

# create the buildbot-slave environment
cd $HOME
buildslave create-slave  --no-logrotate . $BUILDBOT_MASTER $BUILDSLAVE_USER $BUILDSLAVE_PASS
echo $BUILDSLAVE_ADMIN > info/admin
echo `uname -a` > info/host

# remove potentially sensitive environment vars so they're not logged
unset -v BUILDBOT_MASTER BUILDSLAVE_USER BUILDSLAVE_PASS BUILDSLAVE_ADMIN

# work around docker-in-docker permissions and quirks
sudo $HOME/bin/wrapdocker

# run buildbot-slave in the foreground
twistd --nodaemon --no_save --python buildbot.tac
